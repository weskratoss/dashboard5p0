<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EnergyTech Italia - Dashboard Energetica</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Site Management Panel -->
        <div class="management-panel" id="management-panel">
            <div class="management-header">
                <h2>üè¢ Gestione Siti</h2>
                <button id="toggle-management" class="btn btn--sm btn--secondary">‚ñº Comprimi</button>
            </div>
            
            <div class="management-content" id="management-content">
                <!-- Excel Upload -->
                <div class="card management-card">
                    <h3>üì§ Carica File Excel</h3>
                    <div class="upload-section">
                        <input type="file" id="excel-upload" accept=".xlsx,.xls,.csv" style="display: none;">
                        <button id="upload-btn" class="btn btn--primary btn--full-width" style="padding: var(--space-16) var(--space-24); font-size: var(--font-size-lg);">üìÅ Seleziona File Excel</button>
                        <div class="upload-info">
                            <p style="font-size: var(--font-size-base); margin-bottom: var(--space-12);"><strong>üìã Carica un file Excel (.xlsx) con i seguenti sheet:</strong></p>
                            <p class="text-small">1Ô∏è‚É£ <strong>KPI e coordinate</strong> - Informazioni base siti (OBBLIGATORIO)</p>
                            <p class="text-small">2Ô∏è‚É£ <strong>MODELLO</strong> - Utenze dettagliate (opzionale)</p>
                            <p class="text-small">3Ô∏è‚É£ <strong>POD Fatturati</strong> - Consumi elettrici storici (opzionale)</p>
                            <p class="text-small">4Ô∏è‚É£ <strong>PDR Fatturati</strong> - Consumi gas storici (opzionale)</p>
                            <p class="text-small">5Ô∏è‚É£ <strong>Teleriscaldamento</strong> - Dati teleriscaldamento (opzionale)</p>
                            <p style="margin-top: var(--space-12); font-size: var(--font-size-sm);"><strong>Colonne obbligatorie (KPI e coordinate):</strong> Metallo, DOIT, SITO, Localit√†, lat, long</p>
                            <p class="text-small"><strong>Categorie valide:</strong> Bronze, Silver, Gold, Platinum, OFFICINA, UST</p>
                        </div>
                        <div id="upload-status" class="upload-status"></div>
                    </div>
                </div>

                <!-- Sites List -->
                <div class="card management-card">
                    <div class="sites-header">
                        <h3>üìã Siti Caricati (<span id="sites-count">0</span>)</h3>
                        <div class="sites-actions">
                            <button id="export-json-btn" class="btn btn--sm btn--secondary" title="Esporta in JSON">üíæ JSON</button>
                            <button id="export-excel-btn" class="btn btn--sm btn--secondary" title="Esporta in Excel">üìä Excel</button>
                            <button id="clear-all-btn" class="btn btn--sm btn--outline" style="color: var(--color-error);">üóëÔ∏è Pulisci Tutto</button>
                        </div>
                    </div>
                    <div id="sites-list" class="sites-list">
                        <div class="empty-state" style="padding: var(--space-32); text-align: center;">
                            <div style="font-size: 48px; margin-bottom: var(--space-16);">üìä</div>
                            <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-8);">Nessun sito caricato</div>
                            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">Carica un file Excel per iniziare a visualizzare i dati</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-and-info-container">
        <!-- Left Panel - Map -->
        <div class="map-panel">
            <div class="map-header">
                <h1>EnergyTech Italia S.p.A.</h1>
                <p>Dashboard Consumi Energetici Multisito</p>
                <div class="filter-container">
                    <div class="filter-group">
                        <label for="doit-filter" class="filter-label" title="Filtra i siti per struttura di appartenenza DOIT. Aggiorna tutte le statistiche e i grafici.">
                            <span>üìç DOIT:</span>
                        </label>
                        <select id="doit-filter" class="form-control doit-select">
                            <option value="all">Tutti i siti</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="category-filter" class="filter-label" title="Filtra i siti per categoria. Aggiorna tutte le statistiche e i grafici.">
                            <span>üè∑Ô∏è Categoria:</span>
                        </label>
                        <select id="category-filter" class="form-control category-select">
                            <option value="all">Tutte le categorie</option>
                        </select>
                    </div>
                    <button id="reset-filters-btn" class="btn btn--sm btn--secondary" title="Ripristina visualizzazione di tutti i siti">‚Ü∫ Reset</button>
                    <span id="filter-count" class="filter-count"></span>
                </div>
                <p style="margin-top: var(--space-12); font-size: var(--font-size-xs); color: var(--color-text-secondary); font-style: italic;">
                    üîÑ <strong>Aggiornamento dinamico:</strong> Applicando i filtri sopra, tutti i valori KPI, grafici e tabelle si aggiorneranno automaticamente per mostrare solo i dati dei siti visibili sulla mappa.
                </p>
                <div class="warning-banner">
                    ‚ö†Ô∏è <strong>Nota:</strong> I dati saranno persi al refresh della pagina. Esporta i dati per salvarli.
                </div>
            </div>
            <div id="map"></div>
            <div class="map-legend">
                <div class="legend-title">Categorie Siti</div>
                <div class="legend-items">
                    <!-- Dynamically populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Right Panel - Info & Charts -->
        <div class="info-panel">
            <div class="panel-header">
                <div id="view-title">Vista Generale</div>
                <button id="back-btn" class="btn btn--secondary btn--sm" style="display: none;">‚Üê Torna alla Vista Generale</button>
            </div>

            <!-- Company Overview -->
            <div id="company-overview" class="info-section">
                <!-- KPI Cards: Si aggiornano dinamicamente in base ai filtri applicati -->
                <div class="kpi-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="kpi-card" style="background-color: var(--color-bg-1);" title="Numero di siti visibili sulla mappa dopo l'applicazione dei filtri">
                        <div class="kpi-icon">üè¢</div>
                        <div class="kpi-label">Siti Totali</div>
                        <div class="kpi-value" id="total-sites">125</div>
                        <div class="kpi-breakdown" id="sites-breakdown"></div>
                    </div>
                    <div class="kpi-card" style="background-color: var(--color-bg-2);" title="Consumo elettrico aggregato dai dati del MODELLO per i siti visibili">
                        <div class="kpi-icon">‚ö°</div>
                        <div class="kpi-label">Vettore Elettrico</div>
                        <div class="kpi-value" id="electric-kwh">0 kWh</div>
                        <div class="kpi-subtitle" id="electric-tep">0 TEP</div>
                    </div>
                    <div class="kpi-card" style="background-color: var(--color-bg-3);" title="Consumo gas aggregato dai dati PDR Fatturati (anno 2022) per i siti visibili">
                        <div class="kpi-icon">üî•</div>
                        <div class="kpi-label">Vettore Termico</div>
                        <div class="kpi-value" id="gas-smc">0 Smc</div>
                        <div class="kpi-subtitle" id="gas-tep">0 TEP</div>
                    </div>
                    <div class="kpi-card" style="background-color: var(--color-bg-4);" title="Costo energetico calcolato per i siti visibili (elettrico: 0.21 ‚Ç¨/kWh, gas: 0.745 ‚Ç¨/Smc)">
                        <div class="kpi-icon">üí∞</div>
                        <div class="kpi-label">Costo Energetico Totale</div>
                        <div class="kpi-value" id="total-cost">‚Ç¨ 0</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="card chart-card">
                        <h3>Distribuzione Siti <span class="subtitle">(per categoria - si aggiorna con i filtri)</span></h3>
                        <div class="chart-container">
                            <canvas id="sites-category-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- KPI Comparison Chart -->
                <div id="kpi-comparison-section" class="card" style="display: none;">
                    <h2 style="margin-bottom: var(--space-24);">üìä Confronto KPI Medi tra Categorie</h2>
                    <p style="margin-bottom: var(--space-20); color: var(--color-text-secondary); font-size: var(--font-size-base);">Confronto dei valori medi dei 5 KPI energetici tra le quattro categorie di stazione</p>
                    <div class="chart-container-large" style="height: 450px;">
                        <canvas id="kpi-comparison-chart"></canvas>
                    </div>
                </div>

                <!-- KPI Section by Category (Accordion) -->
                <div id="kpi-by-category-section" class="card" style="display: none;">
                    <h2 style="margin-bottom: var(--space-24);">üìä KPI per Categoria</h2>
                    <div id="category-accordions"></div>
                </div>

                <!-- Ripartizione Consumi Elettrici per Uso Energetico -->
                <div id="uso-energetico-section" class="card" style="display: none;">
                    <h2 style="margin-bottom: var(--space-24);">‚ö° Ripartizione Consumi Elettrici per Uso Energetico</h2>
                    <p style="margin-bottom: var(--space-20); color: var(--color-text-secondary); font-size: var(--font-size-base);">Distribuzione dei consumi elettrici per tipologia di utilizzo energetico. <strong>Fonte:</strong> Sheet MODELLO. <em>Si aggiorna automaticamente in base ai siti filtrati sulla mappa.</em></p>
                    <div class="charts-grid">
                        <div class="chart-card" style="padding: 0;">
                            <h3 style="padding: var(--space-20); padding-bottom: 0;">Grafico Radar</h3>
                            <div class="radar-chart-container" style="height: 350px;">
                                <canvas id="uso-energetico-radar"></canvas>
                            </div>
                        </div>
                        <div class="chart-card" style="padding: 0;">
                            <h3 style="padding: var(--space-20); padding-bottom: 0;">Distribuzione Percentuale</h3>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="uso-energetico-pie"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ripartizione Consumi per Competenza -->
                <div id="competenza-section" class="card" style="display: none;">
                    <h2 style="margin-bottom: var(--space-24);">üë• Ripartizione Consumi Elettrici per Competenza</h2>
                    <p style="margin-bottom: var(--space-20); color: var(--color-text-secondary); font-size: var(--font-size-base);">Analisi dei consumi elettrici suddivisi per ente di competenza. <strong>Fonte:</strong> Sheet MODELLO, colonna Competenza. <em>Si aggiorna automaticamente in base ai siti filtrati sulla mappa.</em></p>
                    <div class="chart-card" style="padding: 0; margin-bottom: var(--space-24);">
                        <h3 style="padding: var(--space-20); padding-bottom: 0;">Grafico a Barre Orizzontali</h3>
                        <div class="chart-container-large" style="height: 400px;">
                            <canvas id="competenza-bar-chart"></canvas>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="competenza-table">
                            <thead>
                                <tr>
                                    <th>Competenza</th>
                                    <th>Consumo (kWh)</th>
                                    <th>Consumo (TEP)</th>
                                    <th>Percentuale</th>
                                    <th>Costo (‚Ç¨)</th>
                                </tr>
                            </thead>
                            <tbody id="competenza-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Site Detail View -->
            <div id="site-detail" class="info-section" style="display: none;">
                <div class="card site-info-card">
                    <h2 id="site-name"></h2>
                    <div class="site-meta">
                        <span class="site-category-badge" id="site-category"></span>
                        <span class="site-doit-badge" id="site-doit-badge"></span>
                    </div>
                </div>

                <div class="site-metadata">
                    <div class="metadata-item">
                        <span class="metadata-label">Localit√†:</span>
                        <span class="metadata-value" id="site-location"></span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">Coordinate:</span>
                        <span class="metadata-value" id="site-coords"></span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">KPI Centralina:</span>
                        <span class="metadata-value" id="site-kpi-centralina"></span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">KPI Stazione:</span>
                        <span class="metadata-value" id="site-kpi-stazione"></span>
                    </div>
                </div>

                <!-- TAB Navigation -->
                <div class="tab-navigation">
                    <button class="tab-btn active" data-tab="riepilogo">üìä Riepilogo</button>
                    <button class="tab-btn" data-tab="utenze">‚ö° Utenze</button>
                    <button class="tab-btn" data-tab="pod">üìà POD Fatturati</button>
                    <button class="tab-btn" data-tab="pdr">üî• PDR Fatturati</button>
                    <button class="tab-btn" data-tab="teleriscaldamento">üå°Ô∏è Teleriscaldamento</button>
                    <button class="tab-btn" data-tab="analisi">üìâ Analisi</button>
                </div>

                <!-- TAB 1: Riepilogo -->
                <div class="tab-content active" id="tab-riepilogo">
                <div class="kpi-grid site-kpi-grid">
                    <div class="kpi-card" style="background-color: var(--color-bg-5);">
                        <div class="kpi-icon">‚ö°</div>
                        <div class="kpi-label">Elettrico</div>
                        <div class="kpi-value" id="site-electric-kwh"></div>
                        <div class="kpi-subtitle" id="site-electric-tep"></div>
                    </div>
                    <div class="kpi-card" style="background-color: var(--color-bg-6);">
                        <div class="kpi-icon">üî•</div>
                        <div class="kpi-label">Gas</div>
                        <div class="kpi-value" id="site-gas-smc"></div>
                        <div class="kpi-subtitle" id="site-gas-tep"></div>
                    </div>
                    <div class="kpi-card" style="background-color: var(--color-bg-7);">
                        <div class="kpi-icon">üìê</div>
                        <div class="kpi-label">Superficie</div>
                        <div class="kpi-value" id="site-superficie">0 m¬≤</div>
                    </div>
                    <div class="kpi-card" style="background-color: var(--color-bg-8);">
                        <div class="kpi-icon">üë•</div>
                        <div class="kpi-label">Dipendenti</div>
                        <div class="kpi-value" id="site-dipendenti">0</div>
                    </div>
                    <div class="kpi-card" style="background-color: var(--color-bg-1);">
                        <div class="kpi-icon">üìä</div>
                        <div class="kpi-label">kWh/m¬≤</div>
                        <div class="kpi-value" id="site-kwh-mq">0</div>
                    </div>
                    <div class="kpi-card" style="background-color: var(--color-bg-2);">
                        <div class="kpi-icon">üë§</div>
                        <div class="kpi-label">kWh/Dipendente</div>
                        <div class="kpi-value" id="site-kwh-dip">0</div>
                    </div>
                    <div class="kpi-card" style="background-color: var(--color-bg-3);">
                        <div class="kpi-icon">üí∞</div>
                        <div class="kpi-label">Costo Annuo</div>
                        <div class="kpi-value" id="site-costo">‚Ç¨ 0</div>
                    </div>
                </div>

                <div class="card chart-card">
                    <h3>Ripartizione Consumi per Uso Energetico</h3>
                    <div class="chart-container">
                        <canvas id="site-uso-chart"></canvas>
                    </div>
                </div>
                </div>

                <!-- TAB 2: Utenze -->
                <div class="tab-content" id="tab-utenze">
                    <div class="card">
                        <div class="card-header-actions">
                            <h3>Utenze del Sito</h3>
                            <button class="btn btn--sm btn--secondary" onclick="exportUtenzeCSV()">üì• Esporta CSV</button>
                        </div>
                        <div class="table-container">
                            <table class="data-table" id="utenze-table">
                                <thead>
                                    <tr>
                                        <th>Nome Utenza</th>
                                        <th>Tipologia</th>
                                        <th>POD</th>
                                        <th>Competenza</th>
                                        <th>Consumo (kWh)</th>
                                        <th>Uso Energetico</th>
                                    </tr>
                                </thead>
                                <tbody id="utenze-tbody"></tbody>
                            </table>
                        </div>
                        <div class="usage-summary" id="usage-summary"></div>
                    </div>
                </div>

                <!-- TAB 3: POD Fatturati -->
                <div class="tab-content" id="tab-pod">
                    <div class="card">
                        <h3>POD Fatturati - Consumi Storici Elettrici</h3>
                        <div id="pod-list"></div>
                        <div class="chart-container-large">
                            <canvas id="pod-trend-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- TAB 4: PDR Fatturati -->
                <div class="tab-content" id="tab-pdr">
                    <div class="card">
                        <h3>PDR Fatturati - Consumi Storici Gas</h3>
                        <div id="pdr-list"></div>
                        <div class="chart-container-large">
                            <canvas id="pdr-trend-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- TAB 5: Teleriscaldamento -->
                <div class="tab-content" id="tab-teleriscaldamento">
                    <div class="card">
                        <h3>Teleriscaldamento</h3>
                        <div id="teleriscaldamento-content"></div>
                    </div>
                </div>

                <!-- TAB 6: Analisi -->
                <div class="tab-content" id="tab-analisi">
                    <div class="kpi-grid">
                        <div class="kpi-card" style="background-color: var(--color-bg-1);">
                            <div class="kpi-icon">üìç</div>
                            <div class="kpi-label">Totale POD</div>
                            <div class="kpi-value" id="analisi-pod-count">0</div>
                        </div>
                        <div class="kpi-card" style="background-color: var(--color-bg-2);">
                            <div class="kpi-icon">üî•</div>
                            <div class="kpi-label">Totale PDR</div>
                            <div class="kpi-value" id="analisi-pdr-count">0</div>
                        </div>
                        <div class="kpi-card" style="background-color: var(--color-bg-3);">
                            <div class="kpi-icon">‚ö°</div>
                            <div class="kpi-label">Totale Utenze</div>
                            <div class="kpi-value" id="analisi-utenze-count">0</div>
                        </div>
                        <div class="kpi-card" style="background-color: var(--color-bg-4);">
                            <div class="kpi-icon">üìä</div>
                            <div class="kpi-label">Consumo Medio/Utenza</div>
                            <div class="kpi-value" id="analisi-avg-consumo">0 kWh</div>
                        </div>
                    </div>
                    <div class="charts-grid">
                        <div class="card chart-card">
                            <h3>Trend Consumi Elettrici</h3>
                            <div class="chart-container">
                                <canvas id="analisi-electric-trend"></canvas>
                            </div>
                        </div>
                        <div class="card chart-card">
                            <h3>Trend Consumi Gas</h3>
                            <div class="chart-container">
                                <canvas id="analisi-gas-trend"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="data.js"></script>
    <script src="app.js"></script>
</body>
</html>